#!/bin/sh

monitor()
{
  local self="`realpath "$0"`"
  local base="`dirname "$self"`"

  source "$base/../env" &&
  merge_environment /srv

  local package='medic-core'
  local service='gammu'
  
  local last_device=''
  local settings_dir="/srv/storage/$package/$service/monitor"

  # Clean up:
  #  These files might be left-over from a previous boot.

  rm -f "$settings_dir/detected" "$settings_dir/detecting" &&
  mkdir -p "$settings_dir"

  # Main loop:
  #  Find the device that's currently in use. If it changes or
  #  goes away entirely, log the event and probe for a new one.
 
  while true; do
    local device="`"$base/gammu-status" gammu`"
    
    if [ -z "$device" ]; then
      rm -f "$settings_dir/detected"
      
      if [ "$last_device" ]; then
        echo "`date`: Device '$last_device' was lost" >&2
      fi
      
      "$base/gammu-status" &>/dev/null

      if [ "$?" -eq 0 ]; then

        touch "$settings_dir/detecting"
        echo "`date`: Possible device(s) found, running autodetection" >&2

        device="`"$base/gammu-autodetect"`"
      
        if [ "$device" ]; then
          echo "`date`: Auto-detection found device '$device'" >&2

          echo "$device" > "$settings_dir/detected" &&
	  /boot/svc-restart "$package" "$service"

	  if [ "$?" -ne 0 ]; then
            rm -f "$settings_dir/detected"
            echo "`date`: Failed to restart '$package/$service'" >&2
	  fi
        fi

      fi
      
      rm -f "$settings_dir/detecting"
    fi

    last_device="$device"    
    sleep 1
  done
  
  return 1
}

main()
{
  monitor
  return "$?"
}

main
exit "$?"

