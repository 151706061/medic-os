#!/bin/sh

persist_ssh_user_configuration_files()
{
  local user="$1"
  shift 1
  
  local ssh_dot_dir="/home/$user/.ssh"
  local ssh_settings_dir="/srv/settings/medic-core/openssh/user/$user"

  mkdir -p "$ssh_dot_dir" "$ssh_settings_dir"

  for file in "$@"; do

    local src_path="$ssh_dot_dir/authorized_keys"
    local target_path="$ssh_settings_dir/authorized_keys"
    
    touch "$target_path"

    if [ -f "$src_path" ]; then
      cat "$src_path" >> "target_path"
    fi

    rm -f "$src_path" &&
    ln -sf "$target_path" "$src_path" &&
    chown "$user.staff" "$target_path"
  done
}

chown -R couchdb.staff \
  /srv/settings/medic-core/couchdb /srv/storage/medic-core/couchdb

chown -R couchdb-lucene.staff \
  /srv/storage/medic-core/couchdb-lucene

persist_ssh_user_configuration_files tc authorized_keys

